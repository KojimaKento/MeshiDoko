# Phase 1-B: æ¤œç´¢æ©Ÿèƒ½å®Ÿè£…ã‚¬ã‚¤ãƒ‰

## æ¦‚è¦

Phase 1-Bã§ã¯ã€ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³æ¤œç´¢æ©Ÿèƒ½ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…ã‚’è¡Œã„ã¾ã™ã€‚

**é–‹ç™ºæ–¹é‡**:
- **ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿æ–¹å¼**ã‚’æ¡ç”¨ã—ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰æ¤œç´¢ã™ã‚‹å®Ÿè£…ã‚’å„ªå…ˆ
- å¾Œã‹ã‚‰å¤–éƒ¨APIï¼ˆãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼APIï¼‰ã«åˆ‡ã‚Šæ›¿ãˆã‚„ã™ã„è¨­è¨ˆ
- å¤–éƒ¨APIã®åˆ¶ç´„ï¼ˆãƒªã‚¯ã‚¨ã‚¹ãƒˆåˆ¶é™ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå–å¾—ã®æ‰‹é–“ï¼‰ã‚’å›é¿ã—ã€é–‹ç™ºã‚¹ãƒ”ãƒ¼ãƒ‰ã‚’å„ªå…ˆ

---

## é–‹ç™ºæ–¹æ³•ã®é¸æŠè‚¢

### æ–¹æ³•1: ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿æ–¹å¼ï¼ˆæ¨å¥¨ãƒ»æ¡ç”¨ï¼‰

**ãƒ¡ãƒªãƒƒãƒˆ**:
- âœ… ã™ãã«é–‹ç™ºã‚’å§‹ã‚ã‚‰ã‚Œã‚‹
- âœ… APIåˆ¶é™ã‚’æ°—ã«ã›ãšé–‹ç™ºã§ãã‚‹
- âœ… ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã‚‚é–‹ç™ºå¯èƒ½
- âœ… å¾Œã‹ã‚‰APIå®Ÿè£…ã«åˆ‡ã‚Šæ›¿ãˆã‚„ã™ã„
- âœ… ãƒ†ã‚¹ãƒˆãŒç°¡å˜

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:
- âŒ å®Ÿãƒ‡ãƒ¼ã‚¿ã§ã¯ãªã„ãŸã‚ã€æœ¬ç•ªç’°å¢ƒã¨ã®ã‚®ãƒ£ãƒƒãƒ—ãŒã‚ã‚‹
- âŒ ãƒ‡ãƒ¼ã‚¿ã®é®®åº¦ãŒä¿è¨¼ã•ã‚Œãªã„

### æ–¹æ³•2: å¤–éƒ¨APIçµ±åˆæ–¹å¼ï¼ˆPhase 2ä»¥é™ã§å®Ÿè£…äºˆå®šï¼‰

**ãƒ¡ãƒªãƒƒãƒˆ**:
- âœ… ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã®æœ€æ–°ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã‚‹
- âœ… å®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã‚’ãƒ†ã‚¹ãƒˆã§ãã‚‹

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:
- âŒ ãƒªã‚¯ã‚¨ã‚¹ãƒˆåˆ¶é™ï¼ˆ1æ—¥3,000ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰
- âŒ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå–å¾—ã®æ‰‹é–“
- âŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¾å­˜

---

## Phase 1-B: ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿æ–¹å¼ã®å®Ÿè£…æ‰‹é †

### ã‚¹ãƒ†ãƒƒãƒ—1: å……å®Ÿã—ãŸã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®ä½œæˆ

`db/seeds.rb`ã«50ä»¶ä»¥ä¸Šã®ãƒªã‚¢ãƒ«ãªãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```ruby
# db/seeds.rb

# æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
puts "Clearing existing data..."
Restaurant.destroy_all
Favorite.destroy_all

puts "Creating seed restaurants..."

# ã‚¸ãƒ£ãƒ³ãƒ«ã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³
genres = ['ç„¼è‚‰', 'ã‚¤ã‚¿ãƒªã‚¢ãƒ³', 'ãã°', 'ã†ã©ã‚“', 'ä¸­è¯', 'ã‚«ãƒ•ã‚§', 'ãƒ©ãƒ¼ãƒ¡ãƒ³', 'å¯¿å¸', 'å±…é…’å±‹', 'ãƒ•ãƒ¬ãƒ³ãƒ', 'å’Œé£Ÿ', 'æ´‹é£Ÿ']

# å ´æ‰€ã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³
locations = [
  { ward: 'æ¸‹è°·åŒº', area: 'æ¸‹è°·' },
  { ward: 'æ–°å®¿åŒº', area: 'æ–°å®¿' },
  { ward: 'æ¸¯åŒº', area: 'å…­æœ¬æœ¨' },
  { ward: 'ç›®é»’åŒº', area: 'ä¸­ç›®é»’' },
  { ward: 'ä¸–ç”°è°·åŒº', area: 'ä¸‰è»’èŒ¶å±‹' },
  { ward: 'å“å·åŒº', area: 'äº”åç”°' },
  { ward: 'ä¸­å¤®åŒº', area: 'éŠ€åº§' }
]

# åº—åã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹
name_prefixes = {
  'ç„¼è‚‰' => ['ç‚', 'æ¥µä¸Š', 'å’Œç‰›', 'æœ¬æ ¼', 'é«˜ç´š'],
  'ã‚¤ã‚¿ãƒªã‚¢ãƒ³' => ['ãƒˆãƒ©ãƒƒãƒˆãƒªã‚¢', 'ã‚ªã‚¹ãƒ†ãƒªã‚¢', 'ãƒªã‚¹ãƒˆãƒ©ãƒ³ãƒ†', 'ãƒ”ãƒƒãƒ„ã‚§ãƒªã‚¢'],
  'ãã°' => ['æ‰‹æ‰“ã¡', 'åå‰²', 'æ›´ç§‘', 'è—ª', 'ç ‚å ´'],
  'ã†ã©ã‚“' => ['è®ƒå²', 'æ­¦è”µé‡', 'ç¨²åº­', 'æ‰‹æ‰“ã¡'],
  'ä¸­è¯' => ['éº»è¾£', 'å››å·', 'åºƒæ±', 'åŒ—äº¬', 'ä¸Šæµ·'],
  'ã‚«ãƒ•ã‚§' => ['ãƒ¢ãƒ¼ãƒ‹ãƒ³ã‚°', 'ã‚µãƒ³ã‚»ãƒƒãƒˆ', 'ãƒ ãƒ¼ãƒ³ãƒ©ã‚¤ãƒˆ', 'ã‚¢ãƒ­ãƒ'],
  'ãƒ©ãƒ¼ãƒ¡ãƒ³' => ['ä¸€è˜­', 'æ¬¡éƒ', 'ä¸‰éƒ', 'å››éƒ', 'äº”éƒ'],
  'å¯¿å¸' => ['é®¨', 'æ±Ÿæˆ¸å‰', 'å›è»¢', 'ç«‹ã¡é£Ÿã„', 'é«˜ç´š'],
  'å±…é…’å±‹' => ['ç‚‰ç«¯', 'å€‹å®¤', 'ãƒ¯ã‚¤ãƒ³', 'æ—¥æœ¬é…’', 'ã‚¯ãƒ©ãƒ•ãƒˆãƒ“ãƒ¼ãƒ«'],
  'ãƒ•ãƒ¬ãƒ³ãƒ' => ['ãƒ“ã‚¹ãƒˆãƒ­', 'ãƒ–ãƒ©ãƒƒã‚¹ãƒªãƒ¼', 'ã‚ªãƒ¼ãƒ™ãƒ«ã‚¸ãƒ¥'],
  'å’Œé£Ÿ' => ['æ‡çŸ³', 'å‰²çƒ¹', 'æ–™äº­', 'å®šé£Ÿ'],
  'æ´‹é£Ÿ' => ['ã‚°ãƒªãƒ«', 'æ´‹é£Ÿå±‹', 'ãƒ€ã‚¤ãƒŠãƒ¼']
}

# åº—åã®ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹
name_suffixes = ['äº­', 'å±‹', 'å‡¦', 'ã‚„', 'ãƒ€ã‚¤ãƒ‹ãƒ³ã‚°', 'ã‚­ãƒƒãƒãƒ³', 'ãƒã‚¦ã‚¹', 'ã‚«ãƒ•ã‚§', 'ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³']

# 50ä»¶ã®ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
50.times do |i|
  genre = genres.sample
  location = locations.sample
  prefix = name_prefixes[genre]&.sample || ''
  suffix = name_suffixes.sample

  Restaurant.create!(
    external_id: "seed_#{i + 1}",
    name: "#{prefix}#{genre}#{suffix} #{location[:area]}åº—",
    genre: genre,
    address: "æ±äº¬éƒ½#{location[:ward]}#{location[:area]}#{rand(1..5)}-#{rand(1..20)}-#{rand(1..30)}",
    latitude: 35.6 + (rand * 0.1),
    longitude: 139.6 + (rand * 0.1),
    budget_lunch: [800, 1000, 1200, 1500, 2000, 2500].sample,
    budget_dinner: [2000, 3000, 4000, 5000, 6000, 8000].sample,
    rating: (3.0 + rand * 2.0).round(1),
    is_open: [true, true, true, false].sample, # 75%ã®ç¢ºç‡ã§å–¶æ¥­ä¸­
    opening_hours: {
      monday: "11:00-23:00",
      tuesday: "11:00-23:00",
      wednesday: "11:00-23:00",
      thursday: "11:00-23:00",
      friday: "11:00-24:00",
      saturday: "11:00-24:00",
      sunday: "11:00-22:00"
    },
    sns_instagram: "https://instagram.com/restaurant_#{i + 1}",
    sns_twitter: "https://twitter.com/restaurant_#{i + 1}",
    sns_facebook: i.even? ? "https://facebook.com/restaurant_#{i + 1}" : nil,
    reservation_url: "https://www.hotpepper.jp/restaurant_#{i + 1}",
    source: "seed_data"
  )
end

puts "âœ… Created #{Restaurant.count} restaurants!"
puts "Sample genres: #{Restaurant.pluck(:genre).uniq.join(', ')}"
puts "Sample locations: #{Restaurant.pluck(:address).map { |a| a.match(/æ±äº¬éƒ½(\S+åŒº)/)[1] }.uniq.join(', ')}"
```

ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’å®Ÿè¡Œï¼š

```bash
rails db:seed
```

ç¢ºèªï¼š

```bash
rails console
> Restaurant.count  # => 50
> Restaurant.pluck(:genre).uniq  # => ã‚¸ãƒ£ãƒ³ãƒ«ä¸€è¦§
> Restaurant.where(genre: 'ç„¼è‚‰')  # => ç„¼è‚‰ã®ãŠåº—
```

---

### ã‚¹ãƒ†ãƒƒãƒ—2: RestaurantSearchServiceã‚¯ãƒ©ã‚¹ã®å®Ÿè£…

å¾Œã‹ã‚‰APIå®Ÿè£…ã«åˆ‡ã‚Šæ›¿ãˆã‚„ã™ã„è¨­è¨ˆã§ã€ã¾ãšã¯DBæ¤œç´¢ç‰ˆã‚’å®Ÿè£…ã—ã¾ã™ã€‚

```ruby
# app/services/restaurant_search_service.rb
class RestaurantSearchService
  # ãƒ¡ã‚¤ãƒ³ã®æ¤œç´¢ãƒ¡ã‚½ãƒƒãƒ‰
  # ç’°å¢ƒå¤‰æ•°ã§APIä½¿ç”¨/DBä½¿ç”¨ã‚’åˆ‡ã‚Šæ›¿ãˆå¯èƒ½
  def self.search(params)
    if use_api?
      search_from_api(params)
    else
      search_from_database(params)
    end
  end

  private

  # APIä½¿ç”¨åˆ¤å®š
  # ç’°å¢ƒå¤‰æ•° USE_HOTPEPPER_API=true ã‹ã¤ HOTPEPPER_API_KEY ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿APIä½¿ç”¨
  def self.use_api?
    ENV['USE_HOTPEPPER_API'] == 'true' && ENV['HOTPEPPER_API_KEY'].present?
  end

  # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰æ¤œç´¢ï¼ˆç¾åœ¨ã®å®Ÿè£…ï¼‰
  def self.search_from_database(params)
    restaurants = Restaurant.all

    # ã‚¸ãƒ£ãƒ³ãƒ«æ¤œç´¢ï¼ˆéƒ¨åˆ†ä¸€è‡´ã€å¤§æ–‡å­—å°æ–‡å­—åŒºåˆ¥ãªã—ï¼‰
    if params[:genre].present?
      restaurants = restaurants.where('genre ILIKE ?', "%#{sanitize_sql_like(params[:genre])}%")
    end

    # å ´æ‰€æ¤œç´¢ï¼ˆä½æ‰€ã§éƒ¨åˆ†ä¸€è‡´ã€å¤§æ–‡å­—å°æ–‡å­—åŒºåˆ¥ãªã—ï¼‰
    if params[:location].present?
      restaurants = restaurants.where('address ILIKE ?', "%#{sanitize_sql_like(params[:location])}%")
    end

    # äºˆç®—æ¤œç´¢ï¼ˆãƒ©ãƒ³ãƒã¾ãŸã¯ãƒ‡ã‚£ãƒŠãƒ¼ã®ã„ãšã‚Œã‹ãŒäºˆç®—ä»¥ä¸‹ï¼‰
    if params[:budget].present?
      budget = params[:budget].to_i
      restaurants = restaurants.where('budget_lunch <= ? OR budget_dinner <= ?', budget, budget)
    end

    # å–¶æ¥­ä¸­ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
    if params[:is_open] == '1' || params[:is_open] == 'true'
      restaurants = restaurants.where(is_open: true)
    end

    # ãƒ©ãƒ³ãƒ€ãƒ ã«8ä»¶å–å¾—ï¼ˆçµæœãŒå¤šã™ãã‚‹å ´åˆã®å¯¾ç­–ï¼‰
    # è©•ä¾¡é †ã‚„ãƒ©ãƒ³ãƒ€ãƒ ãªã©ã€ä¸¦ã³é †ã¯è¦ä»¶ã«å¿œã˜ã¦å¤‰æ›´å¯èƒ½
    restaurants.limit(8).order('RANDOM()')
  end

  # å¤–éƒ¨APIï¼ˆãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼ï¼‰ã‹ã‚‰æ¤œç´¢ï¼ˆPhase 2ä»¥é™ã§å®Ÿè£…ï¼‰
  def self.search_from_api(params)
    # TODO: Faradayã§ãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼ã‚°ãƒ«ãƒ¡ã‚µãƒ¼ãƒAPIã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦Restaurantã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é…åˆ—ã‚’è¿”ã™
    raise NotImplementedError, "API integration is not yet implemented. Set USE_HOTPEPPER_API=false to use database search."
  end

  # SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–
  def self.sanitize_sql_like(string)
    string.gsub(/[%_]/) { |m| "\\#{m}" }
  end
end
```

---

### ã‚¹ãƒ†ãƒƒãƒ—3: RestaurantsControllerã®æ›´æ–°

ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰`RestaurantSearchService`å‘¼ã³å‡ºã—ã«å¤‰æ›´ã—ã¾ã™ã€‚

```ruby
# app/controllers/restaurants_controller.rb
class RestaurantsController < ApplicationController
  def index
    # æ¤œç´¢ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒ1ã¤ã§ã‚‚ã‚ã‚Œã°æ¤œç´¢å®Ÿè¡Œ
    if search_params_present?
      @restaurants = RestaurantSearchService.search(search_params)

      # æ¤œç´¢çµæœãŒ0ä»¶ã®å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      if @restaurants.empty?
        flash.now[:notice] = 'æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹ãŠåº—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚æ¡ä»¶ã‚’å¤‰æ›´ã—ã¦å†åº¦æ¤œç´¢ã—ã¦ãã ã•ã„ã€‚'
      end
    else
      # æ¤œç´¢å‰ã¯ç©ºã®é…åˆ—
      @restaurants = []
    end
  end

  def show
    @restaurant = Restaurant.find(params[:id])
  rescue ActiveRecord::RecordNotFound
    redirect_to root_path, alert: 'ãŠåº—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ'
  end

  private

  def search_params
    params.permit(:genre, :location, :budget, :is_open)
  end

  def search_params_present?
    search_params.values.any?(&:present?)
  end
end
```

---

### ã‚¹ãƒ†ãƒƒãƒ—4: ç’°å¢ƒå¤‰æ•°ã®è¨­å®šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

å°†æ¥çš„ã«APIå®Ÿè£…ã«åˆ‡ã‚Šæ›¿ãˆã‚‹æº–å‚™ã¨ã—ã¦ã€`.env`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”¨æ„ã—ã¾ã™ã€‚

#### dotenv-rails gemã®è¿½åŠ 

```ruby
# Gemfile
group :development, :test do
  gem 'dotenv-rails'
end
```

```bash
bundle install
```

#### .envãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ

```bash
# .env
# Phase 1-B: ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿æ–¹å¼ã‚’ä½¿ç”¨
USE_HOTPEPPER_API=false

# Phase 2ä»¥é™: APIå®Ÿè£…æ™‚ã«ä»¥ä¸‹ã‚’è¨­å®š
# USE_HOTPEPPER_API=true
# HOTPEPPER_API_KEY=your_api_key_here
```

#### .gitignoreã«è¿½åŠ 

```bash
# .gitignore
.env
.env.local
```

---

### ã‚¹ãƒ†ãƒƒãƒ—5: RSpecã§ã®ãƒ†ã‚¹ãƒˆå®Ÿè£…

#### FactoryBotã§ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿å®šç¾©

```ruby
# spec/factories/restaurants.rb
FactoryBot.define do
  factory :restaurant do
    sequence(:external_id) { |n| "test_#{n}" }
    sequence(:name) { |n| "ãƒ†ã‚¹ãƒˆãƒ¬ã‚¹ãƒˆãƒ©ãƒ³#{n}" }
    genre { 'ç„¼è‚‰' }
    address { 'æ±äº¬éƒ½æ¸‹è°·åŒº1-1-1' }
    latitude { 35.6595 }
    longitude { 139.7004 }
    budget_lunch { 1000 }
    budget_dinner { 3000 }
    rating { 4.0 }
    is_open { true }
    opening_hours do
      {
        monday: "11:00-23:00",
        tuesday: "11:00-23:00",
        wednesday: "11:00-23:00",
        thursday: "11:00-23:00",
        friday: "11:00-23:00",
        saturday: "11:00-23:00",
        sunday: "11:00-22:00"
      }
    end
    sns_instagram { 'https://instagram.com/test' }
    reservation_url { 'https://hotpepper.jp/test' }
    source { 'seed_data' }

    # ãƒˆãƒ¬ã‚¤ãƒˆ: ã‚¤ã‚¿ãƒªã‚¢ãƒ³
    trait :italian do
      genre { 'ã‚¤ã‚¿ãƒªã‚¢ãƒ³' }
      name { 'ã‚¤ã‚¿ãƒªã‚¢ãƒ³ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³' }
    end

    # ãƒˆãƒ¬ã‚¤ãƒˆ: æ–°å®¿
    trait :shinjuku do
      address { 'æ±äº¬éƒ½æ–°å®¿åŒº1-1-1' }
    end

    # ãƒˆãƒ¬ã‚¤ãƒˆ: å–¶æ¥­çµ‚äº†
    trait :closed do
      is_open { false }
    end

    # ãƒˆãƒ¬ã‚¤ãƒˆ: é«˜äºˆç®—
    trait :expensive do
      budget_lunch { 3000 }
      budget_dinner { 8000 }
    end
  end
end
```

#### RestaurantSearchServiceã®ãƒ†ã‚¹ãƒˆ

```ruby
# spec/services/restaurant_search_service_spec.rb
require 'rails_helper'

RSpec.describe RestaurantSearchService do
  before do
    # ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆ
    create(:restaurant, name: 'ç„¼è‚‰ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ç‚', genre: 'ç„¼è‚‰', address: 'æ±äº¬éƒ½æ¸‹è°·åŒº1-1-1', budget_lunch: 1000, is_open: true)
    create(:restaurant, :italian, address: 'æ±äº¬éƒ½æ–°å®¿åŒº2-2-2', budget_lunch: 2000, is_open: false)
    create(:restaurant, :expensive, genre: 'ãƒ•ãƒ¬ãƒ³ãƒ', address: 'æ±äº¬éƒ½æ¸¯åŒº3-3-3', is_open: true)
  end

  describe '.search' do
    context 'ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãªã—ã®å ´åˆ' do
      it 'å…¨ã¦ã®ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ãŒè¿”ã‚‹ï¼ˆæœ€å¤§8ä»¶ï¼‰' do
        results = RestaurantSearchService.search({})
        expect(results.count).to be <= 8
        expect(results.count).to eq(3)
      end
    end

    context 'ã‚¸ãƒ£ãƒ³ãƒ«æ¤œç´¢' do
      it 'ç„¼è‚‰ã§æ¤œç´¢ã™ã‚‹ã¨ç„¼è‚‰ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã®ã¿è¿”ã‚‹' do
        results = RestaurantSearchService.search(genre: 'ç„¼è‚‰')
        expect(results.map(&:genre)).to all(include('ç„¼è‚‰'))
      end

      it 'ã‚¤ã‚¿ãƒªã‚¢ãƒ³ã§æ¤œç´¢ã™ã‚‹ã¨ã‚¤ã‚¿ãƒªã‚¢ãƒ³ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã®ã¿è¿”ã‚‹' do
        results = RestaurantSearchService.search(genre: 'ã‚¤ã‚¿ãƒªã‚¢ãƒ³')
        expect(results.map(&:genre)).to all(include('ã‚¤ã‚¿ãƒªã‚¢ãƒ³'))
      end

      it 'éƒ¨åˆ†ä¸€è‡´ã§æ¤œç´¢ã§ãã‚‹' do
        results = RestaurantSearchService.search(genre: 'ã‚¤ã‚¿')
        expect(results).not_to be_empty
      end
    end

    context 'å ´æ‰€æ¤œç´¢' do
      it 'æ¸‹è°·ã§æ¤œç´¢ã™ã‚‹ã¨æ¸‹è°·ã®ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ãŒè¿”ã‚‹' do
        results = RestaurantSearchService.search(location: 'æ¸‹è°·')
        expect(results.map(&:address)).to all(include('æ¸‹è°·'))
      end

      it 'æ–°å®¿ã§æ¤œç´¢ã™ã‚‹ã¨æ–°å®¿ã®ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ãŒè¿”ã‚‹' do
        results = RestaurantSearchService.search(location: 'æ–°å®¿')
        expect(results.map(&:address)).to all(include('æ–°å®¿'))
      end
    end

    context 'äºˆç®—æ¤œç´¢' do
      it '1500å††ä»¥ä¸‹ã§æ¤œç´¢ã™ã‚‹ã¨è©²å½“ã™ã‚‹ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ãŒè¿”ã‚‹' do
        results = RestaurantSearchService.search(budget: 1500)
        expect(results).not_to be_empty
        results.each do |restaurant|
          expect(restaurant.budget_lunch <= 1500 || restaurant.budget_dinner <= 1500).to be true
        end
      end

      it '5000å††ä»¥ä¸‹ã§æ¤œç´¢ã™ã‚‹ã¨è©²å½“ã™ã‚‹ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ãŒè¿”ã‚‹' do
        results = RestaurantSearchService.search(budget: 5000)
        expect(results.count).to eq(3) # å…¨ã¦è©²å½“
      end
    end

    context 'å–¶æ¥­ä¸­ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼' do
      it 'å–¶æ¥­ä¸­ã®ã¿è¡¨ç¤ºï¼ˆæ–‡å­—åˆ—"true"ï¼‰' do
        results = RestaurantSearchService.search(is_open: 'true')
        expect(results.all?(&:is_open)).to be true
        expect(results.count).to eq(2)
      end

      it 'å–¶æ¥­ä¸­ã®ã¿è¡¨ç¤ºï¼ˆæ–‡å­—åˆ—"1"ï¼‰' do
        results = RestaurantSearchService.search(is_open: '1')
        expect(results.all?(&:is_open)).to be true
      end
    end

    context 'è¤‡æ•°æ¡ä»¶ã®çµ„ã¿åˆã‚ã›' do
      it 'ã‚¸ãƒ£ãƒ³ãƒ« + å ´æ‰€ã§æ¤œç´¢' do
        results = RestaurantSearchService.search(genre: 'ç„¼è‚‰', location: 'æ¸‹è°·')
        expect(results).not_to be_empty
        expect(results.first.genre).to include('ç„¼è‚‰')
        expect(results.first.address).to include('æ¸‹è°·')
      end

      it 'ã‚¸ãƒ£ãƒ³ãƒ« + äºˆç®— + å–¶æ¥­ä¸­ã§æ¤œç´¢' do
        results = RestaurantSearchService.search(genre: 'ç„¼è‚‰', budget: 2000, is_open: 'true')
        expect(results).not_to be_empty
        results.each do |restaurant|
          expect(restaurant.genre).to include('ç„¼è‚‰')
          expect(restaurant.is_open).to be true
        end
      end
    end

    context 'çµæœãŒ0ä»¶ã®å ´åˆ' do
      it 'å­˜åœ¨ã—ãªã„ã‚¸ãƒ£ãƒ³ãƒ«ã§æ¤œç´¢ã™ã‚‹ã¨ç©ºé…åˆ—ãŒè¿”ã‚‹' do
        results = RestaurantSearchService.search(genre: 'å­˜åœ¨ã—ãªã„ã‚¸ãƒ£ãƒ³ãƒ«')
        expect(results).to be_empty
      end
    end
  end
end
```

#### RestaurantsControllerã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ†ã‚¹ãƒˆ

```ruby
# spec/requests/restaurants_spec.rb
require 'rails_helper'

RSpec.describe 'Restaurants', type: :request do
  let!(:restaurant) { create(:restaurant, name: 'ãƒ†ã‚¹ãƒˆç„¼è‚‰', genre: 'ç„¼è‚‰', address: 'æ±äº¬éƒ½æ¸‹è°·åŒº1-1-1') }

  describe 'GET /restaurants' do
    context 'æ¤œç´¢ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãªã—ã®å ´åˆ' do
      it 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹200ãŒè¿”ã‚‹' do
        get restaurants_path
        expect(response).to have_http_status(:ok)
      end

      it 'æ¤œç´¢çµæœã¯ç©º' do
        get restaurants_path
        expect(assigns(:restaurants)).to be_empty
      end
    end

    context 'ã‚¸ãƒ£ãƒ³ãƒ«ã§æ¤œç´¢' do
      it 'æ¤œç´¢çµæœãŒè¡¨ç¤ºã•ã‚Œã‚‹' do
        get restaurants_path, params: { genre: 'ç„¼è‚‰' }
        expect(response).to have_http_status(:ok)
        expect(assigns(:restaurants)).not_to be_empty
      end
    end

    context 'å ´æ‰€ã§æ¤œç´¢' do
      it 'æ¤œç´¢çµæœãŒè¡¨ç¤ºã•ã‚Œã‚‹' do
        get restaurants_path, params: { location: 'æ¸‹è°·' }
        expect(response).to have_http_status(:ok)
        expect(assigns(:restaurants)).to include(restaurant)
      end
    end
  end

  describe 'GET /restaurants/:id' do
    it 'ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã‚‹' do
      get restaurant_path(restaurant)
      expect(response).to have_http_status(:ok)
      expect(assigns(:restaurant)).to eq(restaurant)
    end

    context 'å­˜åœ¨ã—ãªã„IDã®å ´åˆ' do
      it 'rootã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹' do
        get restaurant_path(id: 99999)
        expect(response).to redirect_to(root_path)
      end
    end
  end
end
```

ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼š

```bash
bundle exec rspec spec/services/restaurant_search_service_spec.rb
bundle exec rspec spec/requests/restaurants_spec.rb
```

---

### ã‚¹ãƒ†ãƒƒãƒ—6: å‹•ä½œç¢ºèª

1. **ã‚µãƒ¼ãƒãƒ¼èµ·å‹•**

```bash
rails server
```

2. **æ¤œç´¢æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ**
   - http://localhost:3000 ã«ã‚¢ã‚¯ã‚»ã‚¹
   - å„æ¤œç´¢æ¡ä»¶ã‚’è©¦ã™
     - ã‚¸ãƒ£ãƒ³ãƒ«: ç„¼è‚‰ã€ã‚¤ã‚¿ãƒªã‚¢ãƒ³ã€ãƒ©ãƒ¼ãƒ¡ãƒ³ãªã©
     - å ´æ‰€: æ¸‹è°·ã€æ–°å®¿ã€å…­æœ¬æœ¨ãªã©
     - äºˆç®—: 1000, 2000, 5000ãªã©
     - å–¶æ¥­ä¸­: ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ON

3. **æ¤œç´¢çµæœã®ç¢ºèª**
   - 8ä»¶ä»¥ä¸‹ã®çµæœãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨
   - æ¡ä»¶ã«åˆè‡´ã—ãŸãŠåº—ã®ã¿ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨
   - ã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è©³ç´°ç”»é¢ã«é·ç§»ã§ãã‚‹ã“ã¨

---

## Phase 2ä»¥é™: å¤–éƒ¨APIçµ±åˆã¸ã®åˆ‡ã‚Šæ›¿ãˆ

ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿æ–¹å¼ã§é–‹ç™ºãŒå®Œäº†ã—ãŸå¾Œã€å®Ÿãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã„ãŸã„å ´åˆã¯ä»¥ä¸‹ã®æ‰‹é †ã§APIå®Ÿè£…ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚

### 1. ãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼APIçµ±åˆã®æº–å‚™

#### ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå–å¾—

1. [ãƒªã‚¯ãƒ«ãƒ¼ãƒˆWEBã‚µãƒ¼ãƒ“ã‚¹](https://webservice.recruit.co.jp/)ã«ã‚¢ã‚¯ã‚»ã‚¹
2. ã€Œæ–°è¦ç™»éŒ²ã€ã‹ã‚‰ãƒªã‚¯ãƒ«ãƒ¼ãƒˆIDã‚’ä½œæˆï¼ˆç„¡æ–™ï¼‰
3. ãƒ¡ãƒ¼ãƒ«èªè¨¼ã§æœ¬ç™»éŒ²å®Œäº†

#### APIã‚­ãƒ¼å–å¾—

1. ãƒªã‚¯ãƒ«ãƒ¼ãƒˆIDã§ãƒ­ã‚°ã‚¤ãƒ³
2. ã€Œãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼ã‚°ãƒ«ãƒ¡ã‚µãƒ¼ãƒAPIã€ã‚’é¸æŠ
3. åˆ©ç”¨è¦ç´„ã«åŒæ„ã—ã¦APIåˆ©ç”¨ç”³è«‹
4. APIã‚­ãƒ¼ãŒå³åº§ã«ç™ºè¡Œã•ã‚Œã‚‹

#### æ³¨æ„äº‹é …

- **ãƒªã‚¯ã‚¨ã‚¹ãƒˆåˆ¶é™**: 1æ—¥3,000ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¾ã§ï¼ˆç„¡æ–™ãƒ—ãƒ©ãƒ³ï¼‰
- **ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼**: JSON or XMLï¼ˆJSONã‚’æ¨å¥¨ï¼‰
- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `https://webservice.recruit.co.jp/hotpepper/gourmet/v1/`

### 2. Faraday gemã®è¿½åŠ 

```ruby
# Gemfile
gem 'faraday'
gem 'faraday-retry' # ãƒªãƒˆãƒ©ã‚¤å‡¦ç†ç”¨ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
```

```bash
bundle install
```

### 3. ç’°å¢ƒå¤‰æ•°ã®è¨­å®š

```bash
# .env
USE_HOTPEPPER_API=true
HOTPEPPER_API_KEY=your_actual_api_key_here
```

### 4. RestaurantSearchService#search_from_api ã®å®Ÿè£…

```ruby
# app/services/restaurant_search_service.rbï¼ˆAPIç‰ˆï¼‰
def self.search_from_api(params)
  # Faradayã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä½œæˆ
  conn = Faraday.new(url: 'https://webservice.recruit.co.jp') do |f|
    f.request :url_encoded
    f.adapter Faraday.default_adapter
  end

  # APIãƒªã‚¯ã‚¨ã‚¹ãƒˆ
  response = conn.get('/hotpepper/gourmet/v1/') do |req|
    req.params['key'] = ENV['HOTPEPPER_API_KEY']
    req.params['format'] = 'json'

    # ã‚¸ãƒ£ãƒ³ãƒ«ã‚³ãƒ¼ãƒ‰å¤‰æ›ï¼ˆå®Ÿéš›ã®APIã«åˆã‚ã›ã¦èª¿æ•´ï¼‰
    req.params['genre'] = convert_genre_to_code(params[:genre]) if params[:genre].present?

    # å ´æ‰€ï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ï¼‰
    req.params['keyword'] = params[:location] if params[:location].present?

    # äºˆç®—ã‚³ãƒ¼ãƒ‰å¤‰æ›
    req.params['budget'] = convert_budget_to_code(params[:budget]) if params[:budget].present?

    # å–¶æ¥­ä¸­ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆç¾åœ¨æ™‚åˆ»ã§æ¤œç´¢ï¼‰
    if params[:is_open] == '1' || params[:is_open] == 'true'
      req.params['open'] = '1'
    end

    req.params['count'] = 8 # æœ€å¤§8ä»¶
  end

  # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒ‘ãƒ¼ã‚¹
  parse_hotpepper_response(response.body)
rescue Faraday::Error => e
  Rails.logger.error("Hotpepper API Error: #{e.message}")
  [] # ã‚¨ãƒ©ãƒ¼æ™‚ã¯ç©ºé…åˆ—ã‚’è¿”ã™
end

private

def self.parse_hotpepper_response(body)
  data = JSON.parse(body)
  shops = data.dig('results', 'shop') || []

  # ãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’Restaurantã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
  shops.map do |shop|
    Restaurant.new(
      external_id: shop['id'],
      name: shop['name'],
      genre: shop.dig('genre', 'name'),
      address: shop['address'],
      latitude: shop['lat'].to_f,
      longitude: shop['lng'].to_f,
      budget_lunch: shop.dig('budget', 'average')&.to_i,
      budget_dinner: shop.dig('budget', 'average')&.to_i,
      rating: shop['rating']&.to_f || 0.0,
      is_open: shop['open'] == 'å–¶æ¥­ä¸­',
      opening_hours: shop['open'], # è¦æ•´å½¢
      sns_instagram: nil, # ãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼APIã«ã¯å«ã¾ã‚Œãªã„
      reservation_url: shop.dig('urls', 'pc'),
      source: 'hotpepper'
    )
  end
end

def self.convert_genre_to_code(genre)
  # ã‚¸ãƒ£ãƒ³ãƒ«åã‹ã‚‰ãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼ã®ã‚¸ãƒ£ãƒ³ãƒ«ã‚³ãƒ¼ãƒ‰ã«å¤‰æ›
  # å®Ÿéš›ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã¯APIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‚ç…§
  genre_mapping = {
    'ç„¼è‚‰' => 'G001',
    'ã‚¤ã‚¿ãƒªã‚¢ãƒ³' => 'G006',
    'ãƒ©ãƒ¼ãƒ¡ãƒ³' => 'G013',
    # ... ä»–ã®ã‚¸ãƒ£ãƒ³ãƒ«
  }
  genre_mapping[genre]
end

def self.convert_budget_to_code(budget)
  # äºˆç®—ã‹ã‚‰ãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼ã®äºˆç®—ã‚³ãƒ¼ãƒ‰ã«å¤‰æ›
  budget_i = budget.to_i
  case budget_i
  when 0..1000 then 'B009' # ~1000å††
  when 1001..2000 then 'B010' # 1001~2000å††
  when 2001..3000 then 'B011' # 2001~3000å††
  # ... ä»–ã®äºˆç®—å¸¯
  else 'B001' # ã™ã¹ã¦
  end
end
```

### 5. ãƒ†ã‚¹ãƒˆï¼ˆWebMockä½¿ç”¨ï¼‰

```ruby
# spec/services/restaurant_search_service_spec.rbï¼ˆAPIç‰ˆï¼‰
require 'rails_helper'
require 'webmock/rspec'

RSpec.describe RestaurantSearchService do
  describe '.search_from_api' do
    let(:api_response) do
      {
        results: {
          shop: [
            {
              id: 'J001234567',
              name: 'ãƒ†ã‚¹ãƒˆãƒ¬ã‚¹ãƒˆãƒ©ãƒ³',
              genre: { name: 'ç„¼è‚‰' },
              address: 'æ±äº¬éƒ½æ¸‹è°·åŒº1-1-1',
              lat: 35.6595,
              lng: 139.7004,
              budget: { average: 3000 },
              rating: 4.2,
              open: 'å–¶æ¥­ä¸­',
              urls: { pc: 'https://hotpepper.jp/test' }
            }
          ]
        }
      }.to_json
    end

    before do
      stub_request(:get, /webservice\.recruit\.co\.jp/)
        .to_return(status: 200, body: api_response)
    end

    it 'ãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼APIã‹ã‚‰ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã‚’å–å¾—' do
      results = RestaurantSearchService.search_from_api(genre: 'ç„¼è‚‰')
      expect(results).not_to be_empty
      expect(results.first.name).to eq('ãƒ†ã‚¹ãƒˆãƒ¬ã‚¹ãƒˆãƒ©ãƒ³')
    end
  end
end
```

---

## ã¾ã¨ã‚

### Phase 1-Bï¼ˆç¾åœ¨ï¼‰
- âœ… ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿æ–¹å¼ã§å®Ÿè£…
- âœ… å¾Œã‹ã‚‰APIåˆ‡ã‚Šæ›¿ãˆå¯èƒ½ãªè¨­è¨ˆ
- âœ… é–‹ç™ºã‚¹ãƒ”ãƒ¼ãƒ‰å„ªå…ˆ

### Phase 2ä»¥é™
- ğŸ”„ ãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼APIçµ±åˆ
- ğŸ”„ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿å–å¾—
- ğŸ”„ æœ¬ç•ªç’°å¢ƒã§ã®ãƒ†ã‚¹ãƒˆ

**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**: Phase 1-Cï¼ˆãŠæ°—ã«å…¥ã‚Šæ©Ÿèƒ½å®Ÿè£…ï¼‰ã«é€²ã¿ã¾ã™ã€‚
